
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente Gemini + LangChain (UI)</title>
  <meta name="color-scheme" content="dark" />
  <style>
  :root { --bg:#0f1218; --panel:#161a22; --text:#e7e9ee; --muted:#aab1c2; --accent:#51a3ff; --border:#242938; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border)}
  .brand{display:flex;gap:8px;align-items:center}
  .brand .env{color:var(--muted);font-size:12px;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  .actions{display:flex;gap:8px}
  .btn{background:var(--accent);color:#08192b;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{filter:brightness(1.1)}
  .btn-secondary{background:#343a46;color:var(--text)}
  .btn-outline{background:transparent;color:var(--text);border:1px solid var(--border)}
  .container{max-width:900px;margin:0 auto;padding:16px}
  .chat{height:60vh;overflow:auto;border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:10px}
  .messages{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px}
  .msg{display:flex;gap:12px}
  .msg .bubble{max-width:70%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);white-space:pre-wrap}
  .msg.user .bubble{background:#1b2a3c;border-color:#29435c}
  .msg.ai .bubble{background:#1f1f2b}
  .msg .meta{font-size:12px;color:var(--muted)}
  .composer{margin-top:14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px}
  .composer-row{display:flex;gap:8px}
  .composer-row input{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px;background:#0b0e14;color:var(--text)}
  .tools-row{margin-top:10px;display:flex;gap:8px;align-items:center}
  .status{margin-left:auto;color:var(--muted);font-size:12px}
  .modal{border:none;border-radius:12px;padding:0}
  .modal::backdrop{background:rgba(0,0,0,.6)}
  .modal-content{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:16px;min-width:360px}
  .modal-content h3{margin-top:0}
  .modal-content label{display:block;margin-bottom:8px}
  .modal-content input, .modal-content textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#0b0e14;color:var(--text)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .pdf-indicator{display:none;align-items:center;gap:6px;padding:4px 10px;background:#1a3a2a;border:1px solid #2d5a3d;border-radius:8px;font-size:12px;color:#6fcf97}
  .pdf-indicator.visible{display:flex}
  .file-input{display:none}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <strong>Agente Gemini + LangChain</strong>
      <span class="env">UI</span>
    </div>
    <div class="actions">
      <button id="btn-google" class="btn" type="button">Conectar con Google</button>
      <button id="btn-reset" class="btn btn-secondary" type="button" title="Nueva conversaci√≥n">Nuevo chat</button>
    </div>
  </header>

  <main class="container">
    <section id="chat" class="chat">
      <ul id="messages" class="messages" aria-live="polite" aria-relevant="additions"></ul>
    </section>

    <section class="composer">
      <div class="composer-row">
        <input id="input" type="text" placeholder="Escribe tu mensaje‚Ä¶" autocomplete="off" aria-label="Tu mensaje" />
        <button id="send" class="btn" type="button">Enviar</button>
      </div>
      <div class="tools-row">
        <button id="open-email" class="btn btn-outline" type="button">‚úâÔ∏è Enviar correo</button>
        <button id="open-calendar" class="btn btn-outline" type="button">üìÖ Crear evento</button>
        <label for="pdf-input" class="btn btn-outline" style="cursor:pointer">üìÑ Subir PDF</label>
        <input type="file" id="pdf-input" class="file-input" accept=".pdf" />
        <span id="pdf-status" class="pdf-indicator">üìÑ <span id="pdf-name"></span></span>
        <span id="status" class="status" aria-live="polite"></span>
      </div>
    </section>
  </main>

  <!-- Modal: Email -->
  <dialog id="email-modal" class="modal" aria-labelledby="email-title">
    <form class="modal-content" id="email-form" method="dialog">
      <h3 id="email-title">Enviar correo</h3>

      <label for="email-to">Para</label>
      <input id="email-to" name="to" type="email" required placeholder="usuario@dominio.com" />

      <label for="email-subject">Asunto</label>
      <input id="email-subject" name="subject" type="text" required />

      <label for="email-body">Mensaje</label>
      <textarea id="email-body" name="body" rows="6" required></textarea>

      <div class="modal-actions">
        <button class="btn" type="submit">Enviar</button>
        <button class="btn btn-secondary" type="button" id="close-email">Cancelar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Calendar -->
  <dialog id="calendar-modal" class="modal" aria-labelledby="calendar-title">
    <form class="modal-content" id="calendar-form" method="dialog">
      <h3 id="calendar-title">Crear evento</h3>

      <label for="cal-summary">T√≠tulo</label>
      <input id="cal-summary" name="summary" type="text" required placeholder="Reuni√≥n / Evento" />

      <label for="cal-description">Descripci√≥n</label>
      <textarea id="cal-description" name="description" rows="4" placeholder="Detalle del evento"></textarea>

      <div class="grid">
        <label for="cal-start">Inicio (fecha y hora)</label>
        <input id="cal-start" name="start" type="datetime-local" required />

        <label for="cal-end">Fin (fecha y hora)</label>
        <input id="cal-end" name="end" type="datetime-local" required />
      </div>

      <div class="modal-actions">
        <button class="btn" type="submit">Crear</button>
        <button class="btn btn-secondary" type="button" id="close-calendar">Cancelar</button>
      </div>
    </form>
  </dialog>

  <script>
  // ===== Config (ajusta si cambian dominios) =====
  const API_BASE = "https://asistente.ponganos10.online";
  const INVOKE_URL = `${API_BASE}/agent/invoke`;
  const GMAIL_URL  = `${API_BASE}/gmail/send`;
  const CAL_URL    = `${API_BASE}/calendar/event`;
  const PDF_UPLOAD_URL = `${API_BASE}/pdf/upload`;
  const PDF_STATUS_URL = `${API_BASE}/pdf/status`;
  const AUTH_GOOGLE_URL = `${API_BASE}/auth/google`;

  // ===== Estado de UI =====
  const els = {
    messages: document.getElementById("messages"),
    input: document.getElementById("input"),
    send: document.getElementById("send"),
    status: document.getElementById("status"),
    btnGoogle: document.getElementById("btn-google"),
    btnReset: document.getElementById("btn-reset"),
    openEmail: document.getElementById("open-email"),
    emailModal: document.getElementById("email-modal"),
    emailForm: document.getElementById("email-form"),
    emailTo: document.getElementById("email-to"),
    emailSubject: document.getElementById("email-subject"),
    emailBody: document.getElementById("email-body"),
    closeEmail: document.getElementById("close-email"),
    openCalendar: document.getElementById("open-calendar"),
    calModal: document.getElementById("calendar-modal"),
    calForm: document.getElementById("calendar-form"),
    calSummary: document.getElementById("cal-summary"),
    calDescription: document.getElementById("cal-description"),
    calStart: document.getElementById("cal-start"),
    calEnd: document.getElementById("cal-end"),
    closeCalendar: document.getElementById("close-calendar"),
    pdfInput: document.getElementById("pdf-input"),
    pdfStatus: document.getElementById("pdf-status"),
    pdfName: document.getElementById("pdf-name"),
  };

  const sessionId = getOrCreateSessionId();
  let sending = false;

  // ===== Eventos =====
  els.send.addEventListener("click", sendMessage);
  els.input.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });
  els.btnGoogle.addEventListener("click", () => window.location.href = AUTH_GOOGLE_URL);
  els.btnReset.addEventListener("click", resetConversation);
  els.openEmail.addEventListener("click", () => els.emailModal.showModal());
  els.closeEmail.addEventListener("click", () => els.emailModal.close());
  els.emailForm.addEventListener("submit", sendEmail);

  els.openCalendar.addEventListener("click", () => { prefillCalendarTimes(); els.calModal.showModal(); });
  els.closeCalendar.addEventListener("click", () => els.calModal.close());
  els.calForm.addEventListener("submit", createEvent);
  els.pdfInput.addEventListener("change", uploadPdf);

  // Verificar si hay PDF cargado al iniciar
  checkPdfStatus();

  // ===== Funciones =====
  function getOrCreateSessionId() {
    const k = "agent_session_id";
    let id = localStorage.getItem(k);
    if (!id) {
      id = "angel|" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem(k, id);
    }
    return id;
  }

  function appendMessage(role, text) {
    const li = document.createElement("li");
    li.className = `msg ${role}`;
    li.innerHTML = `<div class="bubble">${escapeHtml(text)}</div><div class="meta">${role === "user" ? "T√∫" : "Agente"}</div>`;
    els.messages.appendChild(li);
    els.messages.scrollTop = els.messages.scrollHeight;
  }

  function setStatus(text) { els.status.textContent = text || ""; }

  function resetConversation() {
    localStorage.removeItem("agent_session_id");
    const newId = getOrCreateSessionId();
    setStatus(`Nueva sesi√≥n: ${newId}`);
    els.messages.innerHTML = "";
  }

  async function sendMessage() {
    const text = els.input.value.trim();
    if (!text || sending) return;
    sending = true;
    els.input.value = "";
    appendMessage("user", text);
    setStatus("Pensando‚Ä¶");

    try {
      const res = await fetch(INVOKE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: sessionId, input: text }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
      appendMessage("ai", data.output || "[Sin respuesta]");
    } catch (err) {
      appendMessage("ai", "‚ö†Ô∏è Error al invocar el agente: " + err.message);
    } finally {
      sending = false;
      setStatus("");
    }
  }

  async function sendEmail(e) {
    e.preventDefault();
    const payload = {
      to: els.emailTo.value.trim(),
      subject: els.emailSubject.value.trim(),
      body: els.emailBody.value.trim(),
    };
    if (!payload.to || !payload.subject || !payload.body) return;

    setStatus("Enviando correo‚Ä¶");
    try {
      const res = await fetch(GMAIL_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
      appendMessage("ai", `‚úÖ Correo enviado a ${payload.to}`);
      els.emailModal.close();
      els.emailForm.reset();
    } catch (err) {
      appendMessage("ai", "‚ö†Ô∏è Error al enviar correo: " + err.message);
    } finally {
      setStatus("");
    }
  }

  async function createEvent(e) {
    e.preventDefault();
    const startISO = localDateTimeToISO(els.calStart.value);
    const endISO   = localDateTimeToISO(els.calEnd.value);
    const payload = {
      summary: els.calSummary.value.trim(),
      description: els.calDescription.value.trim(),
      start: startISO,
      end: endISO,
    };
    if (!payload.summary || !payload.start || !payload.end) return;

    setStatus("Creando evento‚Ä¶");
    try {
      const res = await fetch(CAL_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
      appendMessage("ai", `‚úÖ Evento creado: ${payload.summary} (${payload.start} ‚Üí ${payload.end})`);
      els.calModal.close();
      els.calForm.reset();
    } catch (err) {
      appendMessage("ai", "‚ö†Ô∏è Error al crear evento: " + err.message);
    } finally {
      setStatus("");
    }
  }

  function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function prefillCalendarTimes() {
    const now = new Date();
    const in1h = new Date(now.getTime() + 60*60*1000);
    els.calStart.value = toLocalDatetimeValue(now);
    els.calEnd.value   = toLocalDatetimeValue(in1h);
  }

  function toLocalDatetimeValue(d) {
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function localDateTimeToISO(localValue) {
    const d = new Date(localValue);
    const tz = -d.getTimezoneOffset();
    const sign = tz >= 0 ? "+" : "-";
    const hh = String(Math.floor(Math.abs(tz)/60)).padStart(2,"0");
    const mm = String(Math.abs(tz)%60).padStart(2,"0");
    return `${d.toISOString().slice(0,19)}${sign}${hh}:${mm}`;
  }

  // ===== PDF Functions =====
  async function uploadPdf() {
    const file = els.pdfInput.files[0];
    if (!file) return;

    setStatus("Subiendo PDF...");
    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch(PDF_UPLOAD_URL, {
        method: "POST",
        body: formData,
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
      
      els.pdfName.textContent = file.name;
      els.pdfStatus.classList.add("visible");
      appendMessage("ai", `üìÑ PDF "${file.name}" cargado (${data.pages} p√°ginas). Ahora puedes preguntarme sobre su contenido.`);
    } catch (err) {
      appendMessage("ai", "‚ö†Ô∏è Error al subir PDF: " + err.message);
    } finally {
      setStatus("");
      els.pdfInput.value = ""; // Reset input
    }
  }

  async function checkPdfStatus() {
    try {
      const res = await fetch(PDF_STATUS_URL);
      const data = await res.json();
      if (data.loaded) {
        els.pdfName.textContent = data.filename;
        els.pdfStatus.classList.add("visible");
      }
    } catch (e) { /* ignore */ }
  }
  </script>
</body>
</html>
