<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asistente IA - Gemini</title>
  <style>
  :root {
    --bg: #212121;
    --sidebar: #171717;
    --chat-bg: #2f2f2f;
    --input-bg: #404040;
    --text: #ececec;
    --muted: #8e8e8e;
    --accent: #10a37f;
    --accent-hover: #1a7f64;
    --border: #444;
    --user-bubble: #2b5278;
    --ai-bubble: #343541;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
  }

  /* Sidebar */
  .sidebar {
    width: 260px;
    background: var(--sidebar);
    display: flex;
    flex-direction: column;
    padding: 12px;
    border-right: 1px solid var(--border);
  }
  .sidebar-header { margin-bottom: 16px; }
  .new-chat-btn {
    width: 100%;
    padding: 12px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
  }
  .new-chat-btn:hover { background: var(--input-bg); }
  .sidebar-section { margin-top: 20px; }
  .sidebar-section h4 { color: var(--muted); font-size: 12px; margin-bottom: 8px; text-transform: uppercase; }
  .sidebar-btn {
    width: 100%;
    padding: 10px 12px;
    background: transparent;
    border: none;
    border-radius: 8px;
    color: var(--text);
    cursor: pointer;
    font-size: 14px;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.2s;
    margin-bottom: 4px;
  }
  .sidebar-btn:hover { background: var(--input-bg); }
  .sidebar-btn.active { background: var(--accent); color: white; }
  .sidebar-spacer { flex: 1; }
  .pdf-loaded {
    padding: 10px;
    background: #1a3a2a;
    border: 1px solid #2d5a3d;
    border-radius: 8px;
    font-size: 12px;
    color: #6fcf97;
    display: none;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
  }
  .pdf-loaded.visible { display: flex; }
  .pdf-loaded .remove-pdf {
    margin-left: auto;
    background: none;
    border: none;
    color: #ff6b6b;
    cursor: pointer;
    font-size: 16px;
  }

  /* Main Chat Area */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-height: 100vh;
  }
  .chat-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .chat-header h2 { font-size: 16px; font-weight: 500; }
  .status-indicator {
    font-size: 12px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent);
  }

  /* Messages */
  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
  }
  .messages { max-width: 800px; margin: 0 auto; }
  .message {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .message.user .message-avatar { background: var(--user-bubble); }
  .message.ai .message-avatar { background: var(--accent); }
  .message-content {
    flex: 1;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .message.user .message-content { color: var(--text); }
  .message.ai .message-content { color: #d1d5db; }
  .message-attachment {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--input-bg);
    border-radius: 6px;
    font-size: 12px;
    margin-bottom: 8px;
    color: var(--accent);
  }
  .typing-indicator {
    display: flex;
    gap: 4px;
    padding: 8px 0;
  }
  .typing-indicator span {
    width: 8px;
    height: 8px;
    background: var(--muted);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
  }
  .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
  .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
  @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

  /* Input Area */
  .input-area {
    padding: 16px 24px 24px;
    background: var(--bg);
  }
  .input-wrapper {
    max-width: 800px;
    margin: 0 auto;
    background: var(--input-bg);
    border-radius: 16px;
    border: 1px solid var(--border);
    overflow: hidden;
  }
  .attachment-preview {
    display: none;
    padding: 12px 16px;
    background: rgba(16, 163, 127, 0.1);
    border-bottom: 1px solid var(--border);
    align-items: center;
    gap: 8px;
    font-size: 13px;
  }
  .attachment-preview.visible { display: flex; }
  .attachment-preview .file-icon { font-size: 18px; }
  .attachment-preview .file-name { flex: 1; color: var(--accent); }
  .attachment-preview .remove-btn {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 18px;
    padding: 4px;
  }
  .attachment-preview .remove-btn:hover { color: #ff6b6b; }
  .input-row {
    display: flex;
    align-items: flex-end;
    padding: 12px 16px;
    gap: 12px;
  }
  .input-actions {
    display: flex;
    gap: 4px;
  }
  .action-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    border-radius: 8px;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .action-btn:hover { background: var(--chat-bg); color: var(--text); }
  .action-btn.active { color: var(--accent); }
  #message-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 15px;
    resize: none;
    max-height: 200px;
    line-height: 1.5;
    outline: none;
  }
  #message-input::placeholder { color: var(--muted); }
  .send-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--accent);
    color: white;
    cursor: pointer;
    border-radius: 8px;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  .send-btn:hover { background: var(--accent-hover); }
  .send-btn:disabled { background: var(--muted); cursor: not-allowed; }
  .file-input { display: none; }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal.open { display: flex; }
  .modal-box {
    background: var(--sidebar);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 440px;
    animation: modalIn 0.2s ease;
  }
  @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  .modal-box h3 { margin-bottom: 20px; font-size: 18px; }
  .modal-box label { display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted); }
  .modal-box input, .modal-box textarea {
    width: 100%;
    padding: 10px 12px;
    background: var(--input-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    margin-bottom: 16px;
  }
  .modal-box input:focus, .modal-box textarea:focus { outline: none; border-color: var(--accent); }
  .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px; }
  .modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }
  .modal-btn.primary { background: var(--accent); color: white; }
  .modal-btn.primary:hover { background: var(--accent-hover); }
  .modal-btn.secondary { background: var(--input-bg); color: var(--text); }
  .modal-btn.secondary:hover { background: var(--border); }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <button id="new-chat-btn" class="new-chat-btn">
        <span>+</span> Nuevo chat
      </button>
    </div>

    <div class="sidebar-section">
      <h4>Integraciones</h4>
      <button id="btn-google" class="sidebar-btn">
        <span>üîó</span> Conectar Google
      </button>
    </div>

    <div class="sidebar-section">
      <h4>Acciones r√°pidas</h4>
      <button id="open-email" class="sidebar-btn">
        <span>‚úâÔ∏è</span> Enviar correo
      </button>
      <button id="open-calendar" class="sidebar-btn">
        <span>üìÖ</span> Crear evento
      </button>
    </div>

    <div class="sidebar-spacer"></div>

    <div id="pdf-loaded" class="pdf-loaded">
      <span>üìÑ</span>
      <span id="pdf-name">documento.pdf</span>
      <button id="remove-pdf" class="remove-pdf" title="Quitar PDF">√ó</button>
    </div>
  </aside>

  <!-- Main Chat -->
  <main class="main">
    <header class="chat-header">
      <h2>Asistente Gemini</h2>
      <div class="status-indicator">
        <span class="status-dot"></span>
        <span id="status-text">Listo</span>
      </div>
    </header>

    <div class="messages-container">
      <div id="messages" class="messages"></div>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <div id="attachment-preview" class="attachment-preview">
          <span class="file-icon">üìÑ</span>
          <span id="attachment-name" class="file-name"></span>
          <button id="remove-attachment" class="remove-btn" title="Quitar">√ó</button>
        </div>
        <div class="input-row">
          <div class="input-actions">
            <label for="file-input" class="action-btn" title="Adjuntar PDF">
              üìé
            </label>
            <input type="file" id="file-input" class="file-input" accept=".pdf" />
          </div>
          <textarea id="message-input" rows="1" placeholder="Escribe tu mensaje..."></textarea>
          <button id="send-btn" class="send-btn" title="Enviar">‚û§</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Email -->
  <div id="email-modal" class="modal">
    <div class="modal-box">
      <h3>‚úâÔ∏è Enviar correo</h3>
      <label for="email-to">Para</label>
      <input id="email-to" type="email" placeholder="usuario@dominio.com" />
      <label for="email-subject">Asunto</label>
      <input id="email-subject" type="text" placeholder="Asunto del correo" />
      <label for="email-body">Mensaje</label>
      <textarea id="email-body" rows="5" placeholder="Escribe tu mensaje..."></textarea>
      <div class="modal-actions">
        <button id="close-email" class="modal-btn secondary">Cancelar</button>
        <button id="send-email" class="modal-btn primary">Enviar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Calendar -->
  <div id="calendar-modal" class="modal">
    <div class="modal-box">
      <h3>üìÖ Crear evento</h3>
      <label for="cal-summary">T√≠tulo</label>
      <input id="cal-summary" type="text" placeholder="Nombre del evento" />
      <label for="cal-description">Descripci√≥n</label>
      <textarea id="cal-description" rows="3" placeholder="Detalles del evento"></textarea>
      <div class="grid-2">
        <div>
          <label for="cal-start">Inicio</label>
          <input id="cal-start" type="datetime-local" />
        </div>
        <div>
          <label for="cal-end">Fin</label>
          <input id="cal-end" type="datetime-local" />
        </div>
      </div>
      <div class="modal-actions">
        <button id="close-calendar" class="modal-btn secondary">Cancelar</button>
        <button id="create-event" class="modal-btn primary">Crear</button>
      </div>
    </div>
  </div>

  <script>
  // ===== Config =====
  const API_BASE = "https://asistente.ponganos10.online";
  const INVOKE_URL = `${API_BASE}/agent/invoke`;
  const GMAIL_URL = `${API_BASE}/gmail/send`;
  const CAL_URL = `${API_BASE}/calendar/event`;
  const PDF_UPLOAD_URL = `${API_BASE}/pdf/upload`;
  const PDF_STATUS_URL = `${API_BASE}/pdf/status`;
  const AUTH_GOOGLE_URL = `${API_BASE}/auth/google`;

  // ===== State =====
  let sessionId = getOrCreateSessionId();
  let sending = false;
  let pendingFile = null;

  // ===== DOM Elements =====
  const $ = id => document.getElementById(id);
  const messagesEl = $("messages");
  const messageInput = $("message-input");
  const sendBtn = $("send-btn");
  const statusText = $("status-text");
  const fileInput = $("file-input");
  const attachmentPreview = $("attachment-preview");
  const attachmentName = $("attachment-name");
  const pdfLoaded = $("pdf-loaded");
  const pdfName = $("pdf-name");

  // ===== Event Listeners =====
  sendBtn.addEventListener("click", handleSend);
  messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSend(); }
  });
  messageInput.addEventListener("input", autoResize);

  $("new-chat-btn").addEventListener("click", resetChat);
  $("btn-google").addEventListener("click", () => window.location.href = AUTH_GOOGLE_URL);

  // File handling
  fileInput.addEventListener("change", handleFileSelect);
  $("remove-attachment").addEventListener("click", clearPendingFile);
  $("remove-pdf").addEventListener("click", clearLoadedPdf);

  // Modals
  $("open-email").addEventListener("click", () => openModal("email-modal"));
  $("close-email").addEventListener("click", () => closeModal("email-modal"));
  $("send-email").addEventListener("click", sendEmail);

  $("open-calendar").addEventListener("click", () => { prefillCalendarTimes(); openModal("calendar-modal"); });
  $("close-calendar").addEventListener("click", () => closeModal("calendar-modal"));
  $("create-event").addEventListener("click", createEvent);

  // Close modals on backdrop click
  document.querySelectorAll(".modal").forEach(modal => {
    modal.addEventListener("click", e => { if (e.target === modal) closeModal(modal.id); });
  });

  // Init
  checkPdfStatus();

  // ===== Functions =====
  function getOrCreateSessionId() {
    let id = localStorage.getItem("session_id");
    if (!id) {
      id = "user_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("session_id", id);
    }
    return id;
  }

  function resetChat() {
    localStorage.removeItem("session_id");
    sessionId = getOrCreateSessionId();
    messagesEl.innerHTML = "";
    setStatus("Nuevo chat iniciado");
    setTimeout(() => setStatus("Listo"), 2000);
  }

  function setStatus(text) { statusText.textContent = text; }

  function autoResize() {
    messageInput.style.height = "auto";
    messageInput.style.height = Math.min(messageInput.scrollHeight, 200) + "px";
  }

  function appendMessage(role, text, attachment = null) {
    const div = document.createElement("div");
    div.className = `message ${role}`;
    
    let attachmentHtml = "";
    if (attachment) {
      attachmentHtml = `<div class="message-attachment">üìÑ ${escapeHtml(attachment)}</div>`;
    }
    
    div.innerHTML = `
      <div class="message-avatar">${role === "user" ? "üë§" : "‚ú®"}</div>
      <div class="message-content">${attachmentHtml}${escapeHtml(text)}</div>
    `;
    messagesEl.appendChild(div);
    messagesEl.parentElement.scrollTop = messagesEl.parentElement.scrollHeight;
  }

  function showTyping() {
    const div = document.createElement("div");
    div.className = "message ai";
    div.id = "typing-msg";
    div.innerHTML = `
      <div class="message-avatar">‚ú®</div>
      <div class="message-content">
        <div class="typing-indicator"><span></span><span></span><span></span></div>
      </div>
    `;
    messagesEl.appendChild(div);
    messagesEl.parentElement.scrollTop = messagesEl.parentElement.scrollHeight;
  }

  function hideTyping() {
    const el = $("typing-msg");
    if (el) el.remove();
  }

  function handleFileSelect() {
    const file = fileInput.files[0];
    if (!file) return;
    pendingFile = file;
    attachmentName.textContent = file.name;
    attachmentPreview.classList.add("visible");
  }

  function clearPendingFile() {
    pendingFile = null;
    fileInput.value = "";
    attachmentPreview.classList.remove("visible");
  }

  function clearLoadedPdf() {
    pdfLoaded.classList.remove("visible");
    // Optionally call backend to clear PDF
  }

  async function handleSend() {
    const text = messageInput.value.trim();
    if ((!text && !pendingFile) || sending) return;

    sending = true;
    sendBtn.disabled = true;
    
    // If there's a pending file, upload it first
    if (pendingFile) {
      setStatus("Subiendo PDF...");
      const uploaded = await uploadPdf(pendingFile);
      if (!uploaded) {
        sending = false;
        sendBtn.disabled = false;
        return;
      }
      clearPendingFile();
    }

    if (text) {
      messageInput.value = "";
      autoResize();
      appendMessage("user", text);
      setStatus("Pensando...");
      showTyping();

      try {
        const res = await fetch(INVOKE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id: sessionId, input: text }),
        });
        const data = await res.json();
        hideTyping();
        if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
        appendMessage("ai", data.output || "[Sin respuesta]");
      } catch (err) {
        hideTyping();
        appendMessage("ai", "‚ö†Ô∏è Error: " + err.message);
      }
    }

    sending = false;
    sendBtn.disabled = false;
    setStatus("Listo");
  }

  async function uploadPdf(file) {
    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch(PDF_UPLOAD_URL, { method: "POST", body: formData });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
      
      pdfName.textContent = file.name;
      pdfLoaded.classList.add("visible");
      appendMessage("ai", `üìÑ PDF "${file.name}" cargado (${data.pages} p√°ginas). Ahora puedes preguntarme sobre su contenido.`);
      return true;
    } catch (err) {
      appendMessage("ai", "‚ö†Ô∏è Error al subir PDF: " + err.message);
      return false;
    }
  }

  async function checkPdfStatus() {
    try {
      const res = await fetch(PDF_STATUS_URL);
      const data = await res.json();
      if (data.loaded) {
        pdfName.textContent = data.filename;
        pdfLoaded.classList.add("visible");
      }
    } catch (e) { /* ignore */ }
  }

  // ===== Email =====
  async function sendEmail() {
    const to = $("email-to").value.trim();
    const subject = $("email-subject").value.trim();
    const body = $("email-body").value.trim();
    if (!to || !subject || !body) return alert("Completa todos los campos");

    setStatus("Enviando correo...");
    try {
      const res = await fetch(GMAIL_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ to, subject, body }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
      appendMessage("ai", `‚úÖ Correo enviado a ${to}`);
      closeModal("email-modal");
      $("email-to").value = "";
      $("email-subject").value = "";
      $("email-body").value = "";
    } catch (err) {
      appendMessage("ai", "‚ö†Ô∏è Error: " + err.message);
    }
    setStatus("Listo");
  }

  // ===== Calendar =====
  async function createEvent() {
    const summary = $("cal-summary").value.trim();
    const description = $("cal-description").value.trim();
    const start = $("cal-start").value;
    const end = $("cal-end").value;
    if (!summary || !start || !end) return alert("Completa los campos requeridos");

    setStatus("Creando evento...");
    try {
      const res = await fetch(CAL_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          summary,
          description,
          start_datetime: localDateTimeToISO(start),
          end_datetime: localDateTimeToISO(end),
        }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || `HTTP ${res.status}`);
      appendMessage("ai", `‚úÖ Evento "${summary}" creado`);
      closeModal("calendar-modal");
      $("cal-summary").value = "";
      $("cal-description").value = "";
    } catch (err) {
      appendMessage("ai", "‚ö†Ô∏è Error: " + err.message);
    }
    setStatus("Listo");
  }

  function prefillCalendarTimes() {
    const now = new Date();
    const in1h = new Date(now.getTime() + 60 * 60 * 1000);
    $("cal-start").value = toLocalDatetimeValue(now);
    $("cal-end").value = toLocalDatetimeValue(in1h);
  }

  // ===== Utilities =====
  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]));
  }

  function toLocalDatetimeValue(d) {
    const pad = n => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function localDateTimeToISO(val) {
    const d = new Date(val);
    const tz = -d.getTimezoneOffset();
    const sign = tz >= 0 ? "+" : "-";
    const hh = String(Math.floor(Math.abs(tz) / 60)).padStart(2, "0");
    const mm = String(Math.abs(tz) % 60).padStart(2, "0");
    return `${d.toISOString().slice(0, 19)}${sign}${hh}:${mm}`;
  }

  function openModal(id) { $(id).classList.add("open"); }
  function closeModal(id) { $(id).classList.remove("open"); }
  </script>
</body>
</html>
